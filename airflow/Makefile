# Airflow Docker Compose ê´€ë¦¬ë¥¼ ìœ„í•œ Makefile
# ì‚¬ìš©ë²•: make <command>

# ê¸°ë³¸ ëª…ë ¹ì–´
.PHONY: help start stop restart status logs logs-git clean build

# ë„ì›€ë§ (ê¸°ë³¸ ëª…ë ¹ì–´)
help:
	@echo "ğŸš€ Airflow Docker Compose ê´€ë¦¬ ëª…ë ¹ì–´"
	@echo "=================================="
	@echo "make start       - Airflow ì„œë²„ ì‹œì‘"
	@echo "make stop        - Airflow ì„œë²„ ì¤‘ì§€"
	@echo "make restart     - Airflow ì„œë²„ ì¬ì‹œì‘"
	@echo "make status      - ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸"
	@echo "make logs        - ì „ì²´ ë¡œê·¸ í™•ì¸"
	@echo "make logs-git    - Git-sync ë¡œê·¸ í™•ì¸"
	@echo "make logs-web    - ì›¹ì„œë²„ ë¡œê·¸ í™•ì¸"
	@echo "make logs-sch    - ìŠ¤ì¼€ì¤„ëŸ¬ ë¡œê·¸ í™•ì¸"
	@echo "make build       - ì´ë¯¸ì§€ ë¹Œë“œ í›„ ì‹œì‘"
	@echo "make clean       - ëª¨ë“  ì»¨í…Œì´ë„ˆ/ë³¼ë¥¨ ì •ë¦¬"
	@echo "make reset       - ì™„ì „ ì´ˆê¸°í™” (ë°ì´í„° ì‚­ì œ)"
	@echo ""
	@echo "ğŸ”§ ê³ ê¸‰ ëª…ë ¹ì–´"
	@echo "make exec-web    - ì›¹ì„œë²„ ì»¨í…Œì´ë„ˆ ì ‘ì†"
	@echo "make exec-sch    - ìŠ¤ì¼€ì¤„ëŸ¬ ì»¨í…Œì´ë„ˆ ì ‘ì†"
	@echo "make sync-check  - Git ë™ê¸°í™” ìƒíƒœ í™•ì¸"
	@echo "make env-check   - í™˜ê²½ë³€ìˆ˜ í™•ì¸"

# ì„œë²„ ì‹œì‘
start:
	@echo "ğŸš€ Airflow ì„œë²„ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."
	sudo docker-compose up -d
	@echo "âœ… ì„œë²„ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!"
	@echo "ğŸŒ ì›¹ UI: http://localhost:8080"
	@echo "ğŸ‘¤ ì‚¬ìš©ìëª…: airflow | ë¹„ë°€ë²ˆí˜¸: airflow"

# ì„œë²„ ì¤‘ì§€
stop:
	@echo "ğŸ›‘ Airflow ì„œë²„ë¥¼ ì¤‘ì§€í•©ë‹ˆë‹¤..."
	sudo docker-compose down
	@echo "âœ… ì„œë²„ê°€ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤!"

# ì„œë²„ ì¬ì‹œì‘
restart:
	@echo "ğŸ”„ Airflow ì„œë²„ë¥¼ ì¬ì‹œì‘í•©ë‹ˆë‹¤..."
	sudo docker-compose down
	sudo docker-compose up -d
	@echo "âœ… ì„œë²„ê°€ ì¬ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!"
	@echo "ğŸŒ ì›¹ UI: http://localhost:8080"

# ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
status:
	@echo "ğŸ“Š Airflow ì„œë¹„ìŠ¤ ìƒíƒœ:"
	sudo docker-compose ps

# ì „ì²´ ë¡œê·¸ í™•ì¸
logs:
	@echo "ğŸ“‹ ì „ì²´ ë¡œê·¸ë¥¼ í™•ì¸í•©ë‹ˆë‹¤..."
	sudo docker-compose logs

# Git-sync ë¡œê·¸ í™•ì¸
logs-git:
	@echo "ğŸ“‹ Git-sync ë¡œê·¸ë¥¼ í™•ì¸í•©ë‹ˆë‹¤..."
	sudo docker-compose logs git-sync

# ì›¹ì„œë²„ ë¡œê·¸ í™•ì¸
logs-web:
	@echo "ğŸ“‹ ì›¹ì„œë²„ ë¡œê·¸ë¥¼ í™•ì¸í•©ë‹ˆë‹¤..."
	sudo docker-compose logs airflow-webserver

# ìŠ¤ì¼€ì¤„ëŸ¬ ë¡œê·¸ í™•ì¸
logs-sch:
	@echo "ğŸ“‹ ìŠ¤ì¼€ì¤„ëŸ¬ ë¡œê·¸ë¥¼ í™•ì¸í•©ë‹ˆë‹¤..."
	sudo docker-compose logs airflow-scheduler

# ì´ë¯¸ì§€ ë¹Œë“œ í›„ ì‹œì‘
build:
	@echo "ğŸ”¨ Docker ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•˜ê³  ì„œë²„ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."
	sudo docker-compose build
	sudo docker-compose up -d
	@echo "âœ… ë¹Œë“œ ì™„ë£Œ ë° ì„œë²„ ì‹œì‘ë¨!"

# ì»¨í…Œì´ë„ˆ ì •ë¦¬ (ë³¼ë¥¨ ìœ ì§€)
clean:
	@echo "ğŸ§¹ ì»¨í…Œì´ë„ˆë¥¼ ì •ë¦¬í•©ë‹ˆë‹¤..."
	sudo docker-compose down
	sudo docker system prune -f
	@echo "âœ… ì •ë¦¬ ì™„ë£Œ!"

# ì™„ì „ ì´ˆê¸°í™” (ë°ì´í„°ë² ì´ìŠ¤ í¬í•¨)
reset:
	@echo "âš ï¸  ì™„ì „ ì´ˆê¸°í™”ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤ (ëª¨ë“  ë°ì´í„° ì‚­ì œ)..."
	@read -p "ì •ë§ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/N): " confirm; \
	if [ "$$confirm" = "y" ] || [ "$$confirm" = "Y" ]; then \
		sudo docker-compose down -v; \
		sudo docker system prune -f; \
		echo "âœ… ì™„ì „ ì´ˆê¸°í™” ì™„ë£Œ!"; \
	else \
		echo "âŒ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."; \
	fi

# ì›¹ì„œë²„ ì»¨í…Œì´ë„ˆ ì ‘ì†
exec-web:
	@echo "ğŸ–¥ï¸  ì›¹ì„œë²„ ì»¨í…Œì´ë„ˆì— ì ‘ì†í•©ë‹ˆë‹¤..."
	sudo docker-compose exec airflow-webserver bash

# ìŠ¤ì¼€ì¤„ëŸ¬ ì»¨í…Œì´ë„ˆ ì ‘ì†
exec-sch:
	@echo "ğŸ–¥ï¸  ìŠ¤ì¼€ì¤„ëŸ¬ ì»¨í…Œì´ë„ˆì— ì ‘ì†í•©ë‹ˆë‹¤..."
	sudo docker-compose exec airflow-scheduler bash

# Git ë™ê¸°í™” ìƒíƒœ í™•ì¸
sync-check:
	@echo "ğŸ”„ Git ë™ê¸°í™” ìƒíƒœë¥¼ í™•ì¸í•©ë‹ˆë‹¤..."
	@echo "ë§ˆì§€ë§‰ Git-sync ë¡œê·¸:"
	sudo docker-compose logs --tail=10 git-sync

# í™˜ê²½ë³€ìˆ˜ í™•ì¸
env-check:
	@echo "âš™ï¸  í˜„ì¬ í™˜ê²½ë³€ìˆ˜ ì„¤ì •:"
	@echo "Airflow ì‚¬ìš©ì: $$(grep _AIRFLOW_WWW_USER_USERNAME .env | cut -d'=' -f2)"
	@echo "Git ë ˆí¬ì§€í† ë¦¬: $$(grep GIT_SYNC_REPO .env | cut -d'=' -f2)"
	@echo "Git ë¸Œëœì¹˜: $$(grep GIT_SYNC_BRANCH .env | cut -d'=' -f2)"
	@echo "ë™ê¸°í™” ê°„ê²©: $$(grep GIT_SYNC_WAIT .env | cut -d'=' -f2)ì´ˆ"

# ì‹¤ì‹œê°„ ë¡œê·¸ ëª¨ë‹ˆí„°ë§
logs-follow:
	@echo "ğŸ“‹ ì‹¤ì‹œê°„ ë¡œê·¸ë¥¼ ëª¨ë‹ˆí„°ë§í•©ë‹ˆë‹¤ (Ctrl+Cë¡œ ì¢…ë£Œ)..."
	sudo docker-compose logs -f

# Git-sync ì‹¤ì‹œê°„ ë¡œê·¸
logs-git-follow:
	@echo "ğŸ“‹ Git-sync ì‹¤ì‹œê°„ ë¡œê·¸ë¥¼ ëª¨ë‹ˆí„°ë§í•©ë‹ˆë‹¤ (Ctrl+Cë¡œ ì¢…ë£Œ)..."
	sudo docker-compose logs -f git-sync

# í¬íŠ¸ í™•ì¸
port-check:
	@echo "ğŸ” í¬íŠ¸ ì‚¬ìš© ìƒíƒœ:"
	@echo "Airflow ì›¹ì„œë²„ (8080):"
	@sudo netstat -tlnp | grep :8080 || echo "í¬íŠ¸ 8080ì´ ì‚¬ìš©ë˜ì§€ ì•ŠìŒ"
	@echo "PostgreSQL (5432):"
	@sudo netstat -tlnp | grep :5432 || echo "í¬íŠ¸ 5432ê°€ ì‚¬ìš©ë˜ì§€ ì•ŠìŒ"

# ë¹ ë¥¸ ì¬ì‹œì‘ (git-syncë§Œ)
restart-git:
	@echo "ğŸ”„ Git-syncë§Œ ì¬ì‹œì‘í•©ë‹ˆë‹¤..."
	sudo docker-compose restart git-sync
	@echo "âœ… Git-syncê°€ ì¬ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!"

# ê°œë°œ ëª¨ë“œ (ë¡œê·¸ ì¶œë ¥í•˜ë©° ì‹¤í–‰)
dev:
	@echo "ğŸ› ï¸  ê°œë°œ ëª¨ë“œë¡œ ì‹¤í–‰í•©ë‹ˆë‹¤..."
	sudo docker-compose up

# ê¸°ë³¸ íƒ€ê²Ÿì„ helpë¡œ ì„¤ì •
.DEFAULT_GOAL := help 