# Reindeer Project Makefile
.PHONY: help run check format lint test test-cov clean install dev-setup

# ê¸°ë³¸ íƒ€ê²Ÿ
help: ## ë„ì›€ë§ í‘œì‹œ
	@echo "ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´:"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}'

# ê°œë°œ í™˜ê²½
install: ## ì˜ì¡´ì„± ì„¤ì¹˜
	uv sync

dev-setup: install ## ê°œë°œ í™˜ê²½ ì´ˆê¸° ì„¤ì •
	uv run pre-commit install
	@echo "âœ… ê°œë°œ í™˜ê²½ ì„¤ì • ì™„ë£Œ"
	@echo "ğŸ’¡ .env íŒŒì¼ì„ ìƒì„±í•˜ê³  í™˜ê²½ë³€ìˆ˜ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”"

# ì„œë²„ ì‹¤í–‰
run: ## ê°œë°œ ì„œë²„ ì‹¤í–‰
	uv run uvicorn app.app:app --reload --host 0.0.0.0 --port 8000

run-prod: ## í”„ë¡œë•ì…˜ ì„œë²„ ì‹¤í–‰
	uv run uvicorn app.app:app --host 0.0.0.0 --port 8000

# ì½”ë“œ í’ˆì§ˆ
format: ## ì½”ë“œ í¬ë§·íŒ… (black + isort)
	uv run black .
	uv run isort .
	@echo "âœ… ì½”ë“œ í¬ë§·íŒ… ì™„ë£Œ"

lint: ## ë¦°íŒ… ê²€ì‚¬ (flake8 + mypy)
	uv run flake8 .
	uv run mypy .
	@echo "âœ… ë¦°íŒ… ê²€ì‚¬ ì™„ë£Œ"

# í…ŒìŠ¤íŠ¸
test: ## ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
	uv run pytest tests/unit/ -v

test-integration: ## í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰
	uv run pytest tests/integration/ -v

test-all: ## ëª¨ë“  í…ŒìŠ¤íŠ¸ ì‹¤í–‰
	uv run pytest -v

test-cov: ## ì»¤ë²„ë¦¬ì§€ í¬í•¨ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
	uv run pytest --cov=app --cov=browser --cov-report=html --cov-report=term-missing
	@echo "ğŸ“Š ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸: htmlcov/index.html"

# ì¢…í•© ê²€ì‚¬
check: format lint test ## ëª¨ë“  ê²€ì‚¬ ì‹¤í–‰ (CI/CDìš©)
	@echo "ğŸ‰ ëª¨ë“  ê²€ì‚¬ í†µê³¼!"

# ì •ë¦¬
clean: ## ì„ì‹œ íŒŒì¼ ì •ë¦¬
	find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name "*.pyc" -delete 2>/dev/null || true
	find . -type f -name "*.pyo" -delete 2>/dev/null || true
	find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name ".mypy_cache" -exec rm -rf {} + 2>/dev/null || true
	rm -rf htmlcov/ .coverage 2>/dev/null || true
	@echo "ğŸ§¹ ì •ë¦¬ ì™„ë£Œ"

# ì˜ì¡´ì„± ê´€ë¦¬
deps-update: ## ì˜ì¡´ì„± ì—…ë°ì´íŠ¸
	uv sync --upgrade

deps-add: ## ìƒˆ ì˜ì¡´ì„± ì¶”ê°€ (ì˜ˆ: make deps-add PACKAGE=requests)
	uv add $(PACKAGE)

# ê°œë°œ ìœ í‹¸ë¦¬í‹°
shell: ## Python REPL ì‹¤í–‰
	uv run python

api-docs: ## API ë¬¸ì„œ ì„œë²„ ì‹¤í–‰ (ë³„ë„ í„°ë¯¸ë„ì—ì„œ)
	@echo "ğŸš€ API ë¬¸ì„œ: http://localhost:8000/docs"
	@echo "ğŸš€ ReDoc: http://localhost:8000/redoc"

# Docker (í–¥í›„ ì‚¬ìš©)
docker-build: ## Docker ì´ë¯¸ì§€ ë¹Œë“œ
	docker build -t reindeer:latest .

docker-run: ## Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰
	docker run -p 8000:8000 reindeer:latest